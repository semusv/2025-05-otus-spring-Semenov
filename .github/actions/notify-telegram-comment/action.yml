name: 'Notify Telegram about PR comments'
description: 'Send notification to Telegram about new PR comments'

inputs:
  bot-token:
    description: 'Telegram bot token'
    required: true
  chat-id:
    description: 'Telegram chat ID'
    required: true

runs:
  using: "composite"
  steps:
    - name: Prepare Telegram message
      shell: bash
      run: |
        # Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ
        PROJECT_NAME=$GITHUB_REPOSITORY
        PR_NUMBER=${{ github.event.issue.number || github.event.pull_request.number }}
        PR_TITLE="${{ github.event.issue.title || github.event.pull_request.title }}"
        PR_URL="${{ github.event.comment.html_url || github.event.pull_request.html_url }}"
        COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
        COMMENT_BODY="${{ github.event.comment.body }}"
        WORKFLOW_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"

        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ñ
        if [[ "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
          COMMENT_TYPE="ðŸ‘¨â€ðŸ’» ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹ Ðº ÐºÐ¾Ð´Ñƒ"
        else
          COMMENT_TYPE="ðŸ’¬ ÐžÐ±Ñ‰Ð¸Ð¹ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹"
        fi

        # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
        MESSAGE="ðŸ“¦ ÐŸÑ€Ð¾ÐµÐºÑ‚: *$PROJECT_NAME*%0A"
        MESSAGE+="ðŸ“ PR: *#$PR_NUMBER - $PR_TITLE*%0A"
        MESSAGE+="ðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ñ: *$COMMENT_AUTHOR*%0A"
        MESSAGE+="ðŸ“Œ Ð¢Ð¸Ð¿: *$COMMENT_TYPE*%0A%0A"
        MESSAGE+="ðŸ’­ Ð¢ÐµÐºÑÑ‚ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ñ:%0A"
        MESSAGE+="*$COMMENT_BODY*%0A%0A"
        MESSAGE+="ðŸ”— [Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹]($PR_URL)"

        echo "TELEGRAM_MESSAGE=$MESSAGE" >> $GITHUB_ENV

    - name: Notify Telegram
      shell: bash
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ inputs.bot-token }}/sendMessage" \
          -d chat_id=${{ inputs.chat-id }} \
          -d text="${{ env.TELEGRAM_MESSAGE }}" \
          -d parse_mode="Markdown"