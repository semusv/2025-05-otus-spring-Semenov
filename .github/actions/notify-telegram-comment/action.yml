name: 'Telegram PR Notifier'
description: 'Notify about PR comments, reviews and approvals'
inputs:
  bot-token:
    description: 'Telegram bot token'
    required: true
  chat-id:
    description: 'Telegram chat ID'
    required: true

runs:
  using: "composite"
  steps:
    - name: Prepare message
      shell: bash
      run: |
        # ÐžÐ±Ñ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
        PROJECT_NAME="$GITHUB_REPOSITORY"
        PR_NUMBER="${{ github.event.pull_request.number || github.event.issue.number }}"
        PR_TITLE="${{ github.event.pull_request.title || github.event.issue.title }}"
        PR_URL="${{ github.event.pull_request.html_url || github.event.issue.html_url }}"

        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
        if [[ "${{ github.event_name }}" == "pull_request_review" ]]; then
          if [[ "${{ github.event.review.state }}" == "approved" ]]; then
            EVENT_TYPE="âœ… APPROVE"
            AUTHOR="${{ github.event.review.user.login }}"
            BODY="${{ github.event.review.body || 'Ð‘ÐµÐ· ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ñ' }}"
          else
            EVENT_TYPE="ðŸ‘€ REVIEW"
            AUTHOR="${{ github.event.review.user.login }}"
            BODY="${{ github.event.review.body || 'Ð‘ÐµÐ· ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ñ' }}"
          fi
        elif [[ "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
          EVENT_TYPE="ðŸ’¬ CODE COMMENT"
          AUTHOR="${{ github.event.comment.user.login }}"
          BODY="${{ github.event.comment.body }}"
        else
          EVENT_TYPE="ðŸ“ GENERAL COMMENT"
          AUTHOR="${{ github.event.comment.user.login }}"
          BODY="${{ github.event.comment.body }}"
        fi

        # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
        MESSAGE="ðŸ“¦ *ÐŸÑ€Ð¾ÐµÐºÑ‚*: $PROJECT_NAME%0A"
        MESSAGE+="ðŸ”¢ *PR*: #$PR_NUMBER%0A"
        MESSAGE+="ðŸ“Œ *Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº*: $PR_TITLE%0A"
        MESSAGE+="ðŸ‘¤ *ÐÐ²Ñ‚Ð¾Ñ€*: $AUTHOR%0A"
        MESSAGE+="âœ‰ï¸ *Ð¢Ð¸Ð¿*: $EVENT_TYPE%0A%0A"
        [ -n "$BODY" ] && MESSAGE+="ðŸ“„ *Ð¢ÐµÐºÑÑ‚*:%0A$BODY%0A%0A"
        MESSAGE+="ðŸ”— *Ð¡ÑÑ‹Ð»ÐºÐ°*: [ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ PR]($PR_URL)"

        echo "TELEGRAM_MESSAGE=$MESSAGE" >> $GITHUB_ENV

    - name: Send to Telegram
      shell: bash
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ inputs.bot-token }}/sendMessage" \
          -d chat_id="${{ inputs.chat-id }}" \
          -d text="$TELEGRAM_MESSAGE" \
          -d parse_mode="Markdown" \
          -d disable_web_page_preview="true"