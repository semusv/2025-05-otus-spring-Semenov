name: 'Notify Telegram about PR build status'
description: 'Send notification to Telegram about PR build status'

inputs:
  bot-token:
    description: 'Telegram bot token'
    required: true
  chat-id:
    description: 'Telegram chat ID'
    required: true
  build-result:
    description: 'Result of the build job'
    required: true


runs:
  using: "composite"
  steps:
    - name: Prepare Telegram message
      shell: bash
      run: |
        # Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ
        PROJECT_NAME=$GITHUB_REPOSITORY
        BRANCH="${{ github.event.pull_request.head.ref }}"
        TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_BODY="${{ github.event.pull_request.body }}"
        PR_NUMBER=${{ github.event.pull_request.number }}
        PR_URL="${{ github.event.pull_request.html_url }}"
        AUTHOR="${{ github.event.pull_request.user.login }}"
        WORKFLOW_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÑÐ±Ð¾Ñ€ÐºÐ¸
        if [[ "${{ inputs.build-result }}" == "failure" ]]; then
          STATUS="âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸"
        else
          STATUS="âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð°Ñ ÑÐ±Ð¾Ñ€ÐºÐ°"
        fi

        # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
        MESSAGE="ðŸ“¦ ÐŸÑ€Ð¾ÐµÐºÑ‚: *$PROJECT_NAME*%0A"
        MESSAGE+="ðŸ”„ Ð’ÐµÑ‚ÐºÐ°: *$BRANCH â†’ $TARGET_BRANCH*%0A"
        MESSAGE+="ðŸ“ Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº: *$PR_TITLE*%0A"
        MESSAGE+="ðŸ“„ ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ: *$PR_BODY*%0A"
        MESSAGE+="ðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: *$AUTHOR*%0A"
        MESSAGE+="ðŸ”— [Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° PR]($PR_URL)%0A%0A"
        MESSAGE+="âš™ï¸ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: *$STATUS*%0A%0A"
        MESSAGE+="ðŸ” [ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ]($WORKFLOW_URL)"
        
        echo "TELEGRAM_MESSAGE=$MESSAGE" >> $GITHUB_ENV

    - name: Notify Telegram
      shell: bash
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ inputs.bot-token }}/sendMessage" \
          -d chat_id=${{ inputs.chat-id }} \
          -d text="${{ env.TELEGRAM_MESSAGE }}" \
          -d parse_mode="Markdown"