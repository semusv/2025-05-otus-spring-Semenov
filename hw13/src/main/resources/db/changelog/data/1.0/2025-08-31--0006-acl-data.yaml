databaseChangeLog:
  - changeSet:
      id: 2025-08-31--0001-acl-initial-data
      author: vvsemenov
      context: dev
      comment: Предзаполнение данных ACL - классы и SID
      changes:
        # Добавляем классы защищаемых объектов
        - insert:
            tableName: acl_class
            columns:
              - column:
                  name: class
                  value: ru.otus.hw.models.Book
        - insert:
            tableName: acl_class
            columns:
              - column:
                  name: class
                  value: ru.otus.hw.models.Comment

        # Добавляем SID для пользователей
        - insert:
            tableName: acl_sid
            columns:
              - column:
                  name: principal
                  value: true
              - column:
                  name: sid
                  value: user
        - insert:
            tableName: acl_sid
            columns:
              - column:
                  name: principal
                  value: true
              - column:
                  name: sid
                  value: admin

        # Добавляем SID для ролей
        - insert:
            tableName: acl_sid
            columns:
              - column:
                  name: principal
                  value: false
              - column:
                  name: sid
                  value: ROLE_USER
        - insert:
            tableName: acl_sid
            columns:
              - column:
                  name: principal
                  value: false
              - column:
                  name: sid
                  value: ROLE_ADMIN
        - insert:
            tableName: acl_sid
            columns:
              - column:
                  name: principal
                  value: false
              - column:
                  name: sid
                  value: ROLE_GUEST
        - insert:
            tableName: acl_sid
            columns:
              - column:
                  name: principal
                  value: true
              - column:
                  name: sid
                  value: guest

  - changeSet:
      id: 2025-08-31--0002-acl-book-permissions
      author: vvsemenov
      context: dev
      comment: Настройка прав доступа на книги
      changes:
        # Создаем Object Identity для книг
        - sql:
            sql: |
              INSERT INTO acl_object_identity (object_id_class, object_id_identity, owner_sid, entries_inheriting)
              VALUES 
              -- Книга 1 принадлежит admin
              ((SELECT id FROM acl_class WHERE class = 'ru.otus.hw.models.Book'), 1, 
               (SELECT id FROM acl_sid WHERE sid = 'admin' AND principal = true), true),
              -- Книга 2 принадлежит user
              ((SELECT id FROM acl_class WHERE class = 'ru.otus.hw.models.Book'), 2, 
               (SELECT id FROM acl_sid WHERE sid = 'user' AND principal = true), true),
              -- Книга 3 не имеет владельца
              ((SELECT id FROM acl_class WHERE class = 'ru.otus.hw.models.Book'), 3, 
               NULL, true);

        # Добавляем права доступа
        - sql:
            sql: |
              INSERT INTO acl_entry (acl_object_identity, ace_order, sid, mask, granting, audit_success, audit_failure)
              VALUES 
              -- Admin имеет все права на все книги
              ((SELECT id FROM acl_object_identity WHERE object_id_identity = 1), 0, 
               (SELECT id FROM acl_sid WHERE sid = 'admin' AND principal = true), 16, true, true, true),
              ((SELECT id FROM acl_object_identity WHERE object_id_identity = 2), 0, 
               (SELECT id FROM acl_sid WHERE sid = 'admin' AND principal = true), 16, true, true, true),
              ((SELECT id FROM acl_object_identity WHERE object_id_identity = 3), 0, 
               (SELECT id FROM acl_sid WHERE sid = 'admin' AND principal = true), 16, true, true, true),

              -- User имеет права на чтение всех книг
              ((SELECT id FROM acl_object_identity WHERE object_id_identity = 1), 1, 
               (SELECT id FROM acl_sid WHERE sid = 'user' AND principal = true), 1, true, true, true),
              ((SELECT id FROM acl_object_identity WHERE object_id_identity = 2), 1, 
               (SELECT id FROM acl_sid WHERE sid = 'user' AND principal = true), 1, true, true, true),
              ((SELECT id FROM acl_object_identity WHERE object_id_identity = 3), 1, 
               (SELECT id FROM acl_sid WHERE sid = 'user' AND principal = true), 1, true, true, true),

              -- User имеет полные права на свою книгу (ID 2)
              ((SELECT id FROM acl_object_identity WHERE object_id_identity = 2), 2, 
               (SELECT id FROM acl_sid WHERE sid = 'user' AND principal = true), 16, true, true, true),

              -- ROLE_ADMIN имеет все права на все книги
              ((SELECT id FROM acl_object_identity WHERE object_id_identity = 1), 3, 
               (SELECT id FROM acl_sid WHERE sid = 'ROLE_ADMIN' AND principal = false), 16, true, true, true),
              ((SELECT id FROM acl_object_identity WHERE object_id_identity = 2), 3, 
               (SELECT id FROM acl_sid WHERE sid = 'ROLE_ADMIN' AND principal = false), 16, true, true, true),
              ((SELECT id FROM acl_object_identity WHERE object_id_identity = 3), 3, 
               (SELECT id FROM acl_sid WHERE sid = 'ROLE_ADMIN' AND principal = false), 16, true, true, true),

              -- ROLE_USER имеет права на чтение всех книг
              ((SELECT id FROM acl_object_identity WHERE object_id_identity = 1), 4, 
               (SELECT id FROM acl_sid WHERE sid = 'ROLE_USER' AND principal = false), 1, true, true, true),
              ((SELECT id FROM acl_object_identity WHERE object_id_identity = 2), 4, 
               (SELECT id FROM acl_sid WHERE sid = 'ROLE_USER' AND principal = false), 1, true, true, true),
              ((SELECT id FROM acl_object_identity WHERE object_id_identity = 3), 4, 
               (SELECT id FROM acl_sid WHERE sid = 'ROLE_USER' AND principal = false), 1, true, true, true);